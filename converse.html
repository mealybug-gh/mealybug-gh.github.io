<!DOCTYPE HTML>
<html class="no-js" lang="en">
<head>
    <title>Converse</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="description" content="Converse XMPP/Jabber Chat"/>
    <meta name="author" content="JC Brand" />
    <meta name="keywords" content="xmpp chat webchat converse.js" />
    <link rel="shortcut icon" type="image/ico" href="/dist/favicon.ico"/>
    <link rel="manifest" href="./manifest.json">
    <link type="text/css" rel="stylesheet" media="screen" href="/dist/converse.min.css" />
    <!-- host libsignal-protocol.min.js locally -->
    <!-- <script src="https://cdn.conversejs.org/3rdparty/libsignal-protocol.min.js"></script> -->
    <script src="/libsignal-protocol.min.js"></script>
    <script src="/dist/converse.min.js"></script>
    <style>
      #conversejs .form-check.login-trusted {
          visibility: hidden;
          height: 0;
      }
      .user-notification {
        padding: 1rem;
        font-family: Arial, Helvetica, sans-serif;
        color: white;
        max-width: 100%;
      }
      .user-notification#before-login {
        background-color: #333;
      }
      .user-notification h1 {
        font-size: 115%;
        margin: 0;
        margin-bottom: 1.15rem;
        color: #cfe2ff;
      }
      .user-notification h2 {
        font-size: 105%;
        margin: 0;
        margin-bottom: 1.05rem;
        color: #cff4fc;
      }
      .user-notification p {
        margin: 0;
        margin-bottom: 1rem;
      }
      .user-notification p span {
        color: #ffda6a;
        font-weight: bold;
      }
      .user-notification p span.green {
        color: #198754;
        background: white;
        border-radius: 4px;
        padding-left: 2px;
        padding-right: 2px;
      }
      .user-notification p span.red {
        color: #dc3545;
        background: white;
        border-radius: 4px;
        padding-left: 2px;
        padding-right: 2px;
      }
      .user-notification a {
        color: #ffda6a;
      }
      .user-notification a:hover,
      .user-notification a:focus,
      .user-notification a:active {
        color: #9ec5fe;
      }
      .user-notification #gotoconverse {
        display: block;
        width: 100%;
        text-align: center;
        padding: .5rem;
        /* border-radius: .5rem; */
        border: none;
        border-radius: .5rem;
        background: #ffda6a;
        color: #031633;
        font-size: 105%;
        font-weight: bold;
        cursor: pointer;
      }
      .user-notification #gotoconverse:hover,
      .user-notification #gotoconverse:focus,
      .user-notification #gotoconverse:active {
        background: #9ec5fe;
      }
      @media (min-width: 768px) {
        .user-notification {
          max-width: 720px;
          margin: 0 auto;
        }
      }
      @media (min-width: 992px) {
        .user-notification {
          max-width: 960px;
          margin: 0 auto;
        }
      }
      #notification-register {
        position: absolute;
        top: 0;
        left: 0;
        width: 100vw;
        max-width: 100vw;
        padding: .5rem;
        padding-right: 1.5rem;
        z-index: 9999;
        box-sizing: border-box;
        background: rgb(57, 116, 145);
      }
      #notification-register .close-button {
        position: absolute;
        top: 6px;
        right: 6px;
        border-radius: 50%;
        background: white;
        color: rgb(57, 116, 145);
        width: 32px;
        height: 32px;
        text-align: center;
        line-height: 32px;
        cursor: pointer;
        opacity: .6;
      }
    </style>
</head>
<body class="converse-fullscreen">
<noscript>You need to enable JavaScript to run the Converse.js chat app.</noscript>
<div id="conversejs-bg"></div>
<div id="notification-register" class="user-notification" style="display: none;">
  <span class="close-button">x</span>
  <p class="loginform register">
    If you do not have an account yet, the link you used recommends the following sign-up page to create your account:
    <br /><br />
    <a id="registration-link" href="#"></a>
    <br /><br />
    <small>
      <em>
        <strong>Please note:</strong> The person who made the link set the registration URL.
        Anyone can make a room link, entering whatever URL they want to.
        <br />
        A registration URL should lead you to a public XMPP / Jabber server's registration page or registration instructions.
        Do not visit sites you don't trust.
        <br />
        A typical, trustworthy registration site will not ask you for personal details. A username,
        a password and an optional e-mail address are usually sufficient to register for a Jabber account.
      </em>
    </small>
  </p>
</div>
<div class="user-notification " id="before-login">
  <h1>Converse.js and OMEMO - Important</h1>
  <p>
    This instance of <a href="http://conversejs.org/">Converse.js</a> XMPP client supports encrypted messaging using the
    <a href="https://en.wikipedia.org/wiki/OMEMO">OMEMO</a> protocol.
  </p>
  <h2>Using Converse.js in browser</h2>
  <p>
    Converse.js needs to store generated keys in the
    <span>local storage</span> of your browser to enable OMEMO.
  </p>
  <p>
    <span>If this is not your computer, please be sure to use the private browsing mode.</span>
    If you didn't use the private browsing mode, please clear both cache and
    hosted app data / website data after use.
  </p>
  <h2>Are my messages encrypted?</h2>
  <p>
    If you see the <span class="green">green closed lock</span> in the bar above your message input, OMEMO
    encryption is <span class="green">active</span>.
  </p>
  <p>
    If you see the <span class="green">green checkmark</span> next to a received message, it was an encrypted
    message.
    <br />
    You won't see these checkmarks next to your own sent messages.
  </p>
  <p>
    If you see a <span class="red">red open lock</span> instead of a green closed lock, OMEMO is not active.
  </p>
  <p>
    You can use this client for both encrypted messaging with other users whose clients
    <a href="https://omemo.top/" target="_blank">support OMEMO</a>, as well as for unencrypted messaging.
    <br />
    Click the green icon to turn encryption off if you want to (your messages will
    readable to the server you're using).
  </p>
  <p>
    OMEMO does support group chat for <span>invite-only rooms</span>.
  </p>
  <h2>Message Archiving (Offline Messages)</h2>
  <p>
    <span>Do not rely on message archiving</span> using this website as a client.
    Once the browser local storage is cleared, you'll lose your stored encryption keys
    and just generate new ones the next time you log on, which can result in you losing
    some offline messages.
  </p>
  <p>
    If you want to rely on message archiving, using an
    <a href="https://omemo.top/" target="_blank">OMEMO enabled</a> mobile or desktop client
    is highly recommended.
  </p>
  <p>
    <button id="gotoconverse" onclick="goToConverse()">>> Start Converse.js</button>
  </p>
</div>
<script>
/* https://conversejs.org/docs/html/configuration.html?highlight=websocket#omemo-default */
/* http://localhost:8080/index.html#?httpBind=https%3A%2F%2Fjabber.de%2Fhttp-bind%2F&server=jabber.de */

class URLMaker {
  paramsToJSON (str) {
    try {
      if (typeof str !== 'string' || str.length < 1 || str.indexOf('=') < 0) return {}
      var pairs = str.slice(0).split('&')
      var result = {}
      pairs.forEach(function (pair) {
        pair = pair.split('=')
        result[pair[0]] = decodeURIComponent(pair[1] || '')
      })
      return JSON.parse(JSON.stringify(result))
    } catch (e) {
      return {}
    }
  }
  paramsFromHash (hash, loginValues) {
    hash = hash && hash.length ? hash : window.location.hash
    if ( ! hash ) {
      return loginValues
    }
    if (hash.indexOf('#') >= 0) {
      hash = hash.split('#', 2)
      hash = hash.length > 1 ? hash[1] : hash[0]
    }
    if (typeof hash !== 'string' || hash.length < 1) return false
    hash = hash.split('?')
    if (hash.length < 1) return false
    hash = hash[1]
    if (typeof hash !== 'string' || hash.length < 1) return false

    var vals = this.paramsToJSON(hash)
    for (var k in loginValues) {
      if (typeof vals[k] === 'string') loginValues[k] = vals[k]
    }
    return loginValues
  }
}

var goToConverse = function() {
  var urlMaker = new URLMaker()
  var params = urlMaker.paramsFromHash(window.location.hash, {
    httpBind: '',
    server: '',
    room: '',
    register: ''
  })

  if ( ! params.httpBind || ! params.httpBind.length ) {
    params.httpBind = 'https://jabber.de/http-bind/';
    alert('HTTP bind (BOSH) URL not specified, using default: https://jabber.de/http-bind/');
  }

  var converseParams = {
    auto_away: 300,
    auto_reconnect: true,
    bosh_service_url: params.httpBind,
    discover_connection_methods: false,
    view_mode: 'fullscreen',
    theme: 'concord',
    omemo_default: true,
    hide_open_bookmarks: false,
    auto_join_on_invite: true
  }

  if ( params.room && params.room.length ) {
    var rooms = params.room.split(',');
    for ( var i = 0; i < rooms.length; i++) {
      rooms[i] = { jid: rooms[i].trim(), minimized: true };
    }
    converseParams.auto_join_rooms = rooms;
  }

  if ( params.register && params.register.length ) {
    document.getElementById('registration-link').setAttribute('href', params.register);
    document.getElementById('registration-link').innerHTML = params.register;
    document.getElementById('notification-register').style.display = 'block';
    document.querySelector('#notification-register .close-button').addEventListener('click', function() {
      document.getElementById('notification-register').style.display = 'none';
    });
  }

  if (params.server) {
    converseParams.default_domain = params.server;
    converseParams.domain_placeholder = params.server;
    if ( ! params.register || ! params.register.length ) {
      converseParams.registration_domain = params.server;
    }
  }

  console.log(converseParams);

  converse.initialize(converseParams)

  document.querySelector('body > .user-notification#before-login').style.display = 'none';
};

</script>
</body>
</html>
